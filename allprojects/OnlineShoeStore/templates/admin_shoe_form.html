{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">{% if shoe %}แก้ไขสินค้า{% else %}เพิ่มสินค้าใหม่{% endif %}</h1>

    <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">ชื่อสินค้า</label>
                <input type="text" id="name" name="name" value="{{ shoe.name if shoe else '' }}" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black transition-colors">
            </div>

            <div>
                <label for="price" class="block text-sm font-medium text-gray-700 mb-2">ราคา</label>
                <input type="number" id="price" name="price" value="{{ shoe.price if shoe else '' }}" required step="0.01"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black transition-colors">
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">รายละเอียด</label>
                <textarea id="description" name="description" rows="4" required
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black transition-colors">{{ shoe.description if shoe else '' }}</textarea>
            </div>

            <div>
                <label for="total_stock" class="block text-sm font-medium text-gray-700 mb-2">สต็อกรวม</label>
                <input type="number" id="total_stock" name="total_stock" value="{{ shoe.sizes|sum(attribute='stock') if shoe else 0 }}" readonly
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-700">
                <p class="text-sm text-gray-500 mt-1">*จำนวนสต็อกรวมจะคำนวณอัตโนมัติจากจำนวนสต็อกของแต่ละไซส์</p>
            </div>

            <div>
                <label for="category" class="block text-sm font-medium text-gray-700 mb-2">หมวดหมู่</label>
                <select id="category_id" name="category_id" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black transition-colors">
                    <option value="">เลือกหมวดหมู่</option>
                    {% for category in categories %}
                        {% if category.parent_id is none %}
                            <optgroup label="{{ category.name }}">
                                <option value="{{ category.id }}" {% if shoe and shoe.category_id == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% for subcategory in categories %}
                                    {% if subcategory.parent_id == category.id %}
                                        <option value="{{ subcategory.id }}" {% if shoe and shoe.category_id == subcategory.id %}selected{% endif %}>
                                            &nbsp;&nbsp;{{ subcategory.name }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </optgroup>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ไซส์และจำนวน</label>
                <div class="grid grid-cols-2 gap-4">
                    {% for size in range(36, 45) %}
                    <div class="flex items-center space-x-2">
                        <label for="size_{{ size }}" class="text-sm">ไซส์ {{ size }}</label>
                        <input type="number" id="size_{{ size }}" name="size_{{ size }}" 
                               value="{{ shoe.sizes|selectattr('size', 'equalto', size)|map(attribute='stock')|first if shoe else 0 }}"
                               min="0" class="w-24 px-2 py-1 border border-gray-300 rounded">
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div>
                <label for="image" class="block text-sm font-medium text-gray-700 mb-2">รูปภาพสินค้า</label>
                {% if shoe and shoe.image_url %}
                <img src="{{ shoe.image_url }}" alt="{{ shoe.name }}" class="w-32 h-32 object-cover mb-4 rounded">
                {% endif %}
                <input type="file" id="image" name="image" accept="image/*"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-black transition-colors">
            </div>

            <div class="flex justify-end space-x-4">
                <a href="{{ url_for('admin_dashboard') }}" 
                   class="px-6 py-3 bg-gray-100 text-black rounded-lg hover:bg-gray-200">
                    ยกเลิก
                </a>
                <button type="submit" 
                        class="px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800">
                    {% if shoe %}บันทึกการแก้ไข{% else %}เพิ่มสินค้า{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ฟังก์ชันคำนวณสต็อกรวม
        function calculateTotalStock() {
            const sizeInputs = document.querySelectorAll('input[name^="size_"]');
            let totalStock = 0;
            
            sizeInputs.forEach(input => {
                const stockValue = parseInt(input.value) || 0;
                totalStock += stockValue;
            });
            
            document.getElementById('total_stock').value = totalStock;
        }
        
        // เพิ่ม event listener ให้กับทุก input ของไซส์
        const sizeInputs = document.querySelectorAll('input[name^="size_"]');
        sizeInputs.forEach(input => {
            input.addEventListener('input', calculateTotalStock);
        });
        
        // คำนวณสต็อกรวมเมื่อโหลดหน้า
        calculateTotalStock();
    });
</script>
{% endblock %} 