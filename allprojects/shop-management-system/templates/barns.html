{% extends 'base.html' %}

{% block title %}จัดการโรงเรือน - ระบบจัดการฟาร์มไก่{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">จัดการโรงเรือน</h1>
        <p class="text-gray-600 mt-1">จัดการข้อมูลโรงเรือนและติดตามสภาพแวดล้อม</p>
    </div>
    <a href="{{ url_for('add_barn') }}" class="bg-primary hover:bg-accent text-white py-2 px-4 rounded-lg inline-flex items-center justify-center transition-colors">
        <i data-feather="plus" class="h-4 w-4 mr-2"></i>
        <span>เพิ่มโรงเรือนใหม่</span>
    </a>
</div>

{% if barns %}
    <!-- ส่วนค้นหาและกรอง -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6 border border-gray-100">
        <div class="flex flex-col sm:flex-row gap-4">
            <div class="relative flex-grow">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-feather="search" class="h-4 w-4 text-gray-400"></i>
                </div>
                <input type="text" id="search" placeholder="ค้นหาโรงเรือน..." 
                    class="pl-10 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div class="sm:w-48">
                <select id="filter-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="all">สถานะทั้งหมด</option>
                    <option value="ใช้งานอยู่">ใช้งานอยู่</option>
                    <option value="ว่าง">ว่าง</option>
                    <option value="ปิดซ่อมแซม">ปิดซ่อมแซม</option>
                </select>
            </div>
        </div>
    </div>

    <!-- การแสดงผลแบบการ์ด -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for barn in barns %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden barn-card" data-status="{{ barn.status }}">
            <!-- หัวการ์ดแสดงสถานะ -->
            <div class="border-b p-4 flex justify-between items-center
                {% if barn.status == 'ใช้งานอยู่' %}bg-green-50 border-green-100
                {% elif barn.status == 'ว่าง' %}bg-blue-50 border-blue-100
                {% else %}bg-red-50 border-red-100{% endif %}">
                <h3 class="font-medium text-gray-900">{{ barn.name }}</h3>
                <span class="px-2 py-1 rounded-full text-xs font-medium
                    {% if barn.status == 'ใช้งานอยู่' %}bg-green-100 text-green-800
                    {% elif barn.status == 'ว่าง' %}bg-blue-100 text-blue-800
                    {% else %}bg-red-100 text-red-800{% endif %}">
                    {{ barn.status }}
                </span>
            </div>
            
            <!-- ข้อมูลโรงเรือน -->
            <div class="p-4">
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <p class="text-gray-500">ความจุ:</p>
                        <p class="font-medium text-gray-900">{{ barn.capacity }} ตัว</p>
                    </div>
                    <div>
                        <p class="text-gray-500">จำนวนไก่ปัจจุบัน:</p>
                        <p class="font-medium text-gray-900">{{ barn.chickens|length }} ตัว</p>
                    </div>
                    <div>
                        <p class="text-gray-500">อุณหภูมิ:</p>
                        <p class="font-medium text-gray-900">{{ barn.temperature|default('--', true) }} °C</p>
                    </div>
                    <div>
                        <p class="text-gray-500">ความชื้น:</p>
                        <p class="font-medium text-gray-900">{{ barn.humidity|default('--', true) }} %</p>
                    </div>
                </div>
                
                <!-- กราฟอุณหภูมิและความชื้น -->
                <div class="mt-4 h-32">
                    <canvas id="chart-{{ barn.id }}"></canvas>
                </div>
                
                <!-- รายละเอียดเพิ่มเติม -->
                <div class="mt-4">
                    <p class="text-sm text-gray-500">รายละเอียด:</p>
                    <p class="text-sm text-gray-700">{{ barn.description|default('ไม่มีรายละเอียดเพิ่มเติม', true)|truncate(100) }}</p>
                </div>
            </div>
            
            <!-- ปุ่มการจัดการ -->
            <div class="border-t border-gray-100 p-4 flex justify-between">
                <a href="{{ url_for('view_barn', barn_id=barn.id) }}" class="text-primary hover:text-accent text-sm flex items-center">
                    <i data-feather="eye" class="h-4 w-4 mr-1"></i>
                    <span>ดูรายละเอียด</span>
                </a>
                <div class="flex space-x-3">
                    <a href="{{ url_for('edit_barn', barn_id=barn.id) }}" class="text-blue-600 hover:text-blue-800" title="แก้ไข">
                        <i data-feather="edit-2" class="h-4 w-4"></i>
                    </a>
                    <button onclick="if(confirmDelete('คุณต้องการลบข้อมูลโรงเรือนนี้ใช่หรือไม่?')) { window.location.href='{{ url_for('delete_barn', barn_id=barn.id) }}'; }" class="text-red-600 hover:text-red-800" title="ลบ">
                        <i data-feather="trash-2" class="h-4 w-4"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="bg-white rounded-lg shadow-sm p-8 text-center border border-gray-100">
        <div class="flex flex-col items-center justify-center">
            <i data-feather="home" class="h-16 w-16 text-gray-400 mb-4"></i>
            <h3 class="text-xl font-medium text-gray-900 mb-2">ยังไม่มีข้อมูลโรงเรือน</h3>
            <p class="text-gray-600 max-w-md mx-auto mb-6">คุณยังไม่มีข้อมูลโรงเรือนในระบบ เริ่มต้นโดยการเพิ่มโรงเรือนแรกของคุณ</p>
            <a href="{{ url_for('add_barn') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-accent">
                <i data-feather="plus" class="h-4 w-4 mr-2"></i>
                เพิ่มโรงเรือนแรก
            </a>
        </div>
    </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // การค้นหาและกรอง
        const searchInput = document.getElementById('search');
        const statusFilter = document.getElementById('filter-status');
        const barnCards = document.querySelectorAll('.barn-card');
        
        if (searchInput && statusFilter) {
            // ฟังก์ชันค้นหาและกรอง
            function filterBarns() {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                
                barnCards.forEach(card => {
                    const name = card.querySelector('h3').textContent.toLowerCase();
                    const status = card.dataset.status;
                    const matchesSearch = name.includes(searchTerm);
                    const matchesStatus = statusValue === 'all' || status === statusValue;
                    
                    card.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
                });
            }
            
            // เรียกใช้ฟังก์ชันเมื่อมีการเปลี่ยนแปลงในช่องค้นหาหรือตัวกรอง
            searchInput.addEventListener('input', filterBarns);
            statusFilter.addEventListener('change', filterBarns);
        }

        // สร้างกราฟสำหรับแต่ละโรงเรือน
        {% for barn in barns %}
            // สร้างข้อมูลจำลองสำหรับกราฟ
            const tempData = {
                '6:00': 25.2, '9:00': 26.5, '12:00': 28.3, '15:00': 29.1, '18:00': 27.8, '21:00': 26.0, '0:00': 25.5
            };
            
            const humidityData = {
                '6:00': 68, '9:00': 65, '12:00': 60, '15:00': 58, '18:00': 62, '21:00': 65, '0:00': 67
            };
            
            const ctx = document.getElementById('chart-{{ barn.id }}').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(tempData),
                    datasets: [
                        {
                            label: 'อุณหภูมิ (°C)',
                            data: Object.values(tempData),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'ความชื้น (%)',
                            data: Object.values(humidityData),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 10,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 20,
                            max: 35,
                            grid: {
                                display: false
                            },
                            ticks: {
                                display: false
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 40,
                            max: 80,
                            grid: {
                                display: false
                            },
                            ticks: {
                                display: false
                            }
                        }
                    }
                }
            });
        {% endfor %}
    });
</script>
{% endblock %} 