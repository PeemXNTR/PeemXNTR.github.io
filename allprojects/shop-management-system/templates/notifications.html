{% extends 'base.html' %}

{% block title %}การแจ้งเตือน - ระบบจัดการฟาร์มไก่{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold text-gray-800">ศูนย์การแจ้งเตือนระบบ</h1>
        <div class="space-x-2">
            <button id="mark-all-read" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-accent">
                <i data-feather="check-circle" class="h-4 w-4 inline-block mr-1"></i> 
                ทำเครื่องหมายว่าอ่านทั้งหมดแล้ว
            </button>
            <a href="{{ url_for('dashboard') }}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                <i data-feather="settings" class="h-4 w-4 inline-block mr-1"></i>
                การตั้งค่าการแจ้งเตือน
            </a>
        </div>
    </div>

    <!-- แท็บเมนู -->
    <div class="border-b border-gray-200 mb-6">
        <nav class="flex -mb-px space-x-8">
            <button id="tab-all" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-primary text-primary font-medium text-sm">
                ทั้งหมด <span class="ml-2 px-2 py-1 rounded-full bg-primary bg-opacity-10 text-primary text-xs">{{ all_notifications|length }}</span>
            </button>
            <button id="tab-unread" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                ยังไม่ได้อ่าน <span class="ml-2 px-2 py-1 rounded-full bg-yellow-100 text-yellow-800 text-xs">{{ unread_notifications|length }}</span>
            </button>
            <button id="tab-feed" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                อาหาร <span class="ml-2 px-2 py-1 rounded-full bg-green-100 text-green-800 text-xs">{{ notifications_by_type['อาหาร']|length }}</span>
            </button>
            <button id="tab-health" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                สุขภาพ <span class="ml-2 px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs">{{ notifications_by_type['สุขภาพ']|length }}</span>
            </button>
            <button id="tab-eggs" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                ไข่ <span class="ml-2 px-2 py-1 rounded-full bg-blue-100 text-blue-800 text-xs">{{ notifications_by_type['ไข่']|length }}</span>
            </button>
            <button id="tab-vaccine" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                วัคซีน <span class="ml-2 px-2 py-1 rounded-full bg-purple-100 text-purple-800 text-xs">{{ notifications_by_type['วัคซีน']|length }}</span>
            </button>
        </nav>
    </div>

    <!-- ช่องค้นหา -->
    <div class="mb-6">
        <div class="flex gap-4">
            <div class="flex-1 relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-feather="search" class="h-5 w-5 text-gray-400"></i>
                </div>
                <input type="text" id="search-input" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="ค้นหาการแจ้งเตือน...">
            </div>
            <select id="filter-date" class="border border-gray-300 rounded-lg focus:ring-primary focus:border-primary py-2 px-3">
                <option value="all">ทุกวัน</option>
                <option value="today">วันนี้</option>
                <option value="week">สัปดาห์นี้</option>
                <option value="month">เดือนนี้</option>
            </select>
            <button id="clear-filters" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                ล้างตัวกรอง
            </button>
        </div>
    </div>

    <!-- รายการแจ้งเตือน -->
    <div id="all-notifications" class="tab-content">
        {% if all_notifications %}
            <div class="space-y-4">
                {% for notification in all_notifications %}
                    <div class="notification-item bg-white rounded-lg border {% if not notification.is_read %}border-primary{% else %}border-gray-200{% endif %} p-4 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4">
                                <div class="p-2 rounded-full 
                                    {% if notification.type == 'อาหาร' %}bg-green-100{% endif %}
                                    {% if notification.type == 'สุขภาพ' %}bg-red-100{% endif %}
                                    {% if notification.type == 'ไข่' %}bg-blue-100{% endif %}
                                    {% if notification.type == 'วัคซีน' %}bg-purple-100{% endif %}
                                ">
                                    {% if notification.type == 'อาหาร' %}
                                        <i data-feather="coffee" class="h-5 w-5 text-green-600"></i>
                                    {% elif notification.type == 'สุขภาพ' %}
                                        <i data-feather="activity" class="h-5 w-5 text-red-600"></i>
                                    {% elif notification.type == 'ไข่' %}
                                        <i data-feather="package" class="h-5 w-5 text-blue-600"></i>
                                    {% elif notification.type == 'วัคซีน' %}
                                        <i data-feather="thermometer" class="h-5 w-5 text-purple-600"></i>
                                    {% else %}
                                        <i data-feather="bell" class="h-5 w-5 text-gray-600"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-gray-900">{{ notification.title }}</h3>
                                    <p class="text-sm text-gray-600 mt-1">{{ notification.message }}</p>
                                    <div class="flex items-center mt-2 text-xs text-gray-500">
                                        <i data-feather="clock" class="h-3 w-3 mr-1"></i>
                                        {{ notification.created_at.strftime('%d/%m/%Y %H:%M') }}
                                        {% if notification.reference_type %}
                                            <span class="mx-2">•</span>
                                            {% if notification.reference_type == 'chicken' %}
                                                <a href="{{ url_for('chickens') }}" class="text-primary hover:underline flex items-center">
                                                    <i data-feather="link" class="h-3 w-3 mr-1"></i>
                                                    ไก่
                                                </a>
                                            {% elif notification.reference_type == 'barn' %}
                                                <a href="{{ url_for('dashboard') }}" class="text-primary hover:underline flex items-center">
                                                    <i data-feather="link" class="h-3 w-3 mr-1"></i>
                                                    โรงเรือน
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                {% if not notification.is_read %}
                                    <button onclick="markAsRead({{ notification.id }})" class="p-2 text-primary hover:bg-primary-50 rounded-full" title="ทำเครื่องหมายว่าอ่านแล้ว">
                                        <i data-feather="check" class="h-4 w-4"></i>
                                    </button>
                                {% endif %}
                                <button onclick="deleteNotification({{ notification.id }})" class="p-2 text-red-500 hover:bg-red-50 rounded-full" title="ลบการแจ้งเตือน">
                                    <i data-feather="trash-2" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="bg-white rounded-lg p-8 text-center border border-gray-200">
                <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i data-feather="bell-off" class="h-8 w-8 text-gray-400"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">ไม่มีการแจ้งเตือน</h3>
                <p class="text-gray-500 max-w-md mx-auto">ไม่มีการแจ้งเตือนในระบบ คุณจะได้รับการแจ้งเตือนเมื่อมีเหตุการณ์สำคัญเกิดขึ้น</p>
            </div>
        {% endif %}
    </div>

    <div id="unread-notifications" class="tab-content hidden">
        {% if unread_notifications %}
            <div class="space-y-4">
                {% for notification in unread_notifications %}
                    <div class="notification-item bg-white rounded-lg border border-primary p-4 hover:shadow-md transition-shadow duration-200">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4">
                                <div class="p-2 rounded-full 
                                    {% if notification.type == 'อาหาร' %}bg-green-100{% endif %}
                                    {% if notification.type == 'สุขภาพ' %}bg-red-100{% endif %}
                                    {% if notification.type == 'ไข่' %}bg-blue-100{% endif %}
                                    {% if notification.type == 'วัคซีน' %}bg-purple-100{% endif %}
                                ">
                                    {% if notification.type == 'อาหาร' %}
                                        <i data-feather="coffee" class="h-5 w-5 text-green-600"></i>
                                    {% elif notification.type == 'สุขภาพ' %}
                                        <i data-feather="activity" class="h-5 w-5 text-red-600"></i>
                                    {% elif notification.type == 'ไข่' %}
                                        <i data-feather="package" class="h-5 w-5 text-blue-600"></i>
                                    {% elif notification.type == 'วัคซีน' %}
                                        <i data-feather="thermometer" class="h-5 w-5 text-purple-600"></i>
                                    {% else %}
                                        <i data-feather="bell" class="h-5 w-5 text-gray-600"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-gray-900">{{ notification.title }}</h3>
                                    <p class="text-sm text-gray-600 mt-1">{{ notification.message }}</p>
                                    <div class="flex items-center mt-2 text-xs text-gray-500">
                                        <i data-feather="clock" class="h-3 w-3 mr-1"></i>
                                        {{ notification.created_at.strftime('%d/%m/%Y %H:%M') }}
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="markAsRead({{ notification.id }})" class="p-2 text-primary hover:bg-primary-50 rounded-full" title="ทำเครื่องหมายว่าอ่านแล้ว">
                                    <i data-feather="check" class="h-4 w-4"></i>
                                </button>
                                <button onclick="deleteNotification({{ notification.id }})" class="p-2 text-red-500 hover:bg-red-50 rounded-full" title="ลบการแจ้งเตือน">
                                    <i data-feather="trash-2" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="bg-white rounded-lg p-8 text-center border border-gray-200">
                <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i data-feather="check-circle" class="h-8 w-8 text-green-500"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">ไม่มีการแจ้งเตือนที่ยังไม่ได้อ่าน</h3>
                <p class="text-gray-500 max-w-md mx-auto">คุณได้อ่านการแจ้งเตือนทั้งหมดแล้ว</p>
            </div>
        {% endif %}
    </div>

    <!-- สำหรับแสดงการแจ้งเตือนตามประเภท -->
    {% for type_key, type_name in [('feed', 'อาหาร'), ('health', 'สุขภาพ'), ('eggs', 'ไข่'), ('vaccine', 'วัคซีน')] %}
        <div id="{{ type_key }}-notifications" class="tab-content hidden">
            {% set notifications = notifications_by_type[type_name] %}
            {% if notifications %}
                <div class="space-y-4">
                    {% for notification in notifications %}
                        <div class="notification-item bg-white rounded-lg border {% if not notification.is_read %}border-primary{% else %}border-gray-200{% endif %} p-4 hover:shadow-md transition-shadow duration-200">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-4">
                                    <div class="p-2 rounded-full 
                                        {% if notification.type == 'อาหาร' %}bg-green-100{% endif %}
                                        {% if notification.type == 'สุขภาพ' %}bg-red-100{% endif %}
                                        {% if notification.type == 'ไข่' %}bg-blue-100{% endif %}
                                        {% if notification.type == 'วัคซีน' %}bg-purple-100{% endif %}
                                    ">
                                        {% if notification.type == 'อาหาร' %}
                                            <i data-feather="coffee" class="h-5 w-5 text-green-600"></i>
                                        {% elif notification.type == 'สุขภาพ' %}
                                            <i data-feather="activity" class="h-5 w-5 text-red-600"></i>
                                        {% elif notification.type == 'ไข่' %}
                                            <i data-feather="package" class="h-5 w-5 text-blue-600"></i>
                                        {% elif notification.type == 'วัคซีน' %}
                                            <i data-feather="thermometer" class="h-5 w-5 text-purple-600"></i>
                                        {% else %}
                                            <i data-feather="bell" class="h-5 w-5 text-gray-600"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-medium text-gray-900">{{ notification.title }}</h3>
                                        <p class="text-sm text-gray-600 mt-1">{{ notification.message }}</p>
                                        <div class="flex items-center mt-2 text-xs text-gray-500">
                                            <i data-feather="clock" class="h-3 w-3 mr-1"></i>
                                            {{ notification.created_at.strftime('%d/%m/%Y %H:%M') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    {% if not notification.is_read %}
                                        <button onclick="markAsRead({{ notification.id }})" class="p-2 text-primary hover:bg-primary-50 rounded-full" title="ทำเครื่องหมายว่าอ่านแล้ว">
                                            <i data-feather="check" class="h-4 w-4"></i>
                                        </button>
                                    {% endif %}
                                    <button onclick="deleteNotification({{ notification.id }})" class="p-2 text-red-500 hover:bg-red-50 rounded-full" title="ลบการแจ้งเตือน">
                                        <i data-feather="trash-2" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="bg-white rounded-lg p-8 text-center border border-gray-200">
                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        {% if type_key == 'feed' %}
                            <i data-feather="coffee" class="h-8 w-8 text-gray-400"></i>
                        {% elif type_key == 'health' %}
                            <i data-feather="activity" class="h-8 w-8 text-gray-400"></i>
                        {% elif type_key == 'eggs' %}
                            <i data-feather="package" class="h-8 w-8 text-gray-400"></i>
                        {% elif type_key == 'vaccine' %}
                            <i data-feather="thermometer" class="h-8 w-8 text-gray-400"></i>
                        {% endif %}
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">ไม่มีการแจ้งเตือนประเภท{{ type_name }}</h3>
                    <p class="text-gray-500 max-w-md mx-auto">คุณจะได้รับการแจ้งเตือนเมื่อมีเหตุการณ์สำคัญเกี่ยวกับ{{ type_name }}เกิดขึ้น</p>
                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // แท็บการแสดงผล
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        function switchTab(tabId) {
            // ซ่อนทุกแท็บ
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            // ล้างการเลือกทุกปุ่ม
            tabButtons.forEach(btn => {
                btn.classList.remove('border-primary', 'text-primary');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // แสดงแท็บที่เลือก
            document.getElementById(tabId + '-notifications').classList.remove('hidden');
            
            // ไฮไลท์ปุ่มที่เลือก
            document.getElementById('tab-' + tabId).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById('tab-' + tabId).classList.add('border-primary', 'text-primary');
        }
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.id.replace('tab-', '');
                switchTab(tabId);
            });
        });
        
        // ค้นหาและกรอง
        const searchInput = document.getElementById('search-input');
        const dateFilter = document.getElementById('filter-date');
        const clearFiltersButton = document.getElementById('clear-filters');
        
        function filterNotifications() {
            const searchTerm = searchInput.value.toLowerCase();
            const dateOption = dateFilter.value;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            document.querySelectorAll('.notification-item').forEach(item => {
                const title = item.querySelector('h3').textContent.toLowerCase();
                const message = item.querySelector('p').textContent.toLowerCase();
                const dateText = item.querySelector('.text-xs.text-gray-500').textContent;
                const dateParts = dateText.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                
                let showBySearch = title.includes(searchTerm) || message.includes(searchTerm);
                let showByDate = true;
                
                if (dateParts && dateOption !== 'all') {
                    const notifDate = new Date(dateParts[3], dateParts[2] - 1, dateParts[1]);
                    
                    if (dateOption === 'today') {
                        showByDate = notifDate >= today;
                    } else if (dateOption === 'week') {
                        showByDate = notifDate >= weekStart;
                    } else if (dateOption === 'month') {
                        showByDate = notifDate >= monthStart;
                    }
                }
                
                if (showBySearch && showByDate) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        if (searchInput) searchInput.addEventListener('input', filterNotifications);
        if (dateFilter) dateFilter.addEventListener('change', filterNotifications);
        
        if (clearFiltersButton) {
            clearFiltersButton.addEventListener('click', function() {
                searchInput.value = '';
                dateFilter.value = 'all';
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.style.display = '';
                });
            });
        }
        
        // ทำเครื่องหมายว่าอ่านแล้ว
        window.markAsRead = function(id) {
            fetch(`/notification/${id}/mark_as_read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        };
        
        // ทำเครื่องหมายว่าอ่านทั้งหมด
        const markAllReadButton = document.getElementById('mark-all-read');
        if (markAllReadButton) {
            markAllReadButton.addEventListener('click', function() {
                fetch('/notifications/mark_all_as_read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            });
        }
        
        // ลบการแจ้งเตือน
        window.deleteNotification = function(id) {
            if (confirm('คุณต้องการลบการแจ้งเตือนนี้ใช่หรือไม่?')) {
                fetch(`/notification/${id}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            }
        };
    });
</script>
{% endblock %}