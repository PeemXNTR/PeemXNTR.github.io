{% extends 'base.html' %}

{% block title %}รายงานและวิเคราะห์ข้อมูล - ระบบจัดการฟาร์มไก่{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">รายงานและวิเคราะห์ข้อมูล</h1>
        <p class="text-gray-600 mt-1">วิเคราะห์ข้อมูลการดำเนินงาน สร้างและส่งออกรายงาน</p>
    </div>
    <div class="flex space-x-2">
        <button id="export-pdf" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg inline-flex items-center text-sm">
            <i data-feather="file-text" class="h-4 w-4 mr-2"></i>
            <span>ส่งออก PDF</span>
        </button>
        <button id="export-excel" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg inline-flex items-center text-sm">
            <i data-feather="file" class="h-4 w-4 mr-2"></i>
            <span>ส่งออก Excel</span>
        </button>
        <button id="schedule-report" class="bg-primary hover:bg-accent text-white py-2 px-4 rounded-lg inline-flex items-center text-sm">
            <i data-feather="clock" class="h-4 w-4 mr-2"></i>
            <span>ตั้งเวลาส่งรายงาน</span>
        </button>
    </div>
</div>

<!-- ตัวกรองรายงาน -->
<div class="bg-white rounded-lg shadow-sm p-4 mb-6 border border-gray-100">
    <form id="report-filter">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="report-type" class="block text-sm font-medium text-gray-700 mb-1">ประเภทรายงาน</label>
                <select id="report-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="egg_production">การผลิตไข่</option>
                    <option value="sales">ยอดขาย</option>
                    <option value="expenses">ค่าใช้จ่าย</option>
                    <option value="profit_loss">กำไรขาดทุน</option>
                    <option value="chicken_health">สุขภาพไก่</option>
                    <option value="feed_consumption">การใช้อาหาร</option>
                </select>
            </div>
            <div>
                <label for="time-period" class="block text-sm font-medium text-gray-700 mb-1">ช่วงเวลา</label>
                <select id="time-period" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="day">รายวัน</option>
                    <option value="week">รายสัปดาห์</option>
                    <option value="month" selected>รายเดือน</option>
                    <option value="quarter">รายไตรมาส</option>
                    <option value="year">รายปี</option>
                    <option value="custom">กำหนดเอง</option>
                </select>
            </div>
            <div class="md:flex md:space-x-4 space-y-4 md:space-y-0">
                <div class="w-full">
                    <label for="date-from" class="block text-sm font-medium text-gray-700 mb-1">จากวันที่</label>
                    <input type="date" id="date-from" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div class="w-full">
                    <label for="date-to" class="block text-sm font-medium text-gray-700 mb-1">ถึงวันที่</label>
                    <input type="date" id="date-to" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <button type="submit" class="bg-primary hover:bg-accent text-white py-2 px-6 rounded-lg inline-flex items-center text-sm">
                <i data-feather="filter" class="h-4 w-4 mr-2"></i>
                <span>กรองข้อมูล</span>
            </button>
        </div>
    </form>
</div>

<!-- แสดงกราฟและข้อมูลสรุป -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- กราฟหลัก -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100 lg:col-span-2">
        <h2 class="text-lg font-medium text-gray-800 mb-4">ข้อมูลการผลิตไข่</h2>
        <div class="h-80">
            <canvas id="mainChart"></canvas>
        </div>
    </div>
    
    <!-- ข้อมูลสรุปรวม -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
        <h2 class="text-lg font-medium text-gray-800 mb-4">สรุปข้อมูล</h2>
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-gray-600">จำนวนไข่ทั้งหมด</span>
                <span class="font-medium text-gray-900">15,240 ฟอง</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">อัตราการออกไข่เฉลี่ย</span>
                <span class="font-medium text-gray-900">82.5%</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">น้ำหนักไข่เฉลี่ย</span>
                <span class="font-medium text-gray-900">58.2 กรัม</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">ไข่แตก/เสียหาย</span>
                <span class="font-medium text-gray-900">320 ฟอง (2.1%)</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">ต้นทุนต่อฟอง</span>
                <span class="font-medium text-gray-900">2.45 บาท</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">ราคาขายเฉลี่ย</span>
                <span class="font-medium text-gray-900">3.80 บาท</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">กำไรต่อฟอง</span>
                <span class="font-medium text-green-600">1.35 บาท</span>
            </div>
        </div>
    </div>
    
    <!-- กราฟวงกลมแสดงประเภทไข่ -->
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
        <h2 class="text-lg font-medium text-gray-800 mb-4">สัดส่วนประเภทไข่</h2>
        <div class="h-64">
            <canvas id="eggTypeChart"></canvas>
        </div>
    </div>
</div>

<!-- ตารางข้อมูลรายละเอียด -->
<div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100 mb-6">
    <h2 class="text-lg font-medium text-gray-800 mb-4">ข้อมูลรายวัน</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        วันที่
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        จำนวนไข่ (ฟอง)
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        อัตราการออกไข่
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        น้ำหนักเฉลี่ย (กรัม)
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ไข่เสียหาย
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        อาหารที่ใช้ (กก.)
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ต้นทุน (บาท)
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">2023-09-01</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">520</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">83.2%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">57.8</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">12 (2.3%)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">48.5</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1,274</td>
                </tr>
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">2023-09-02</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">512</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">82.1%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">58.2</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">10 (2.0%)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">47.8</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1,254</td>
                </tr>
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">2023-09-03</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">526</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">84.3%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">58.5</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">11 (2.1%)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">49.0</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1,288</td>
                </tr>
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">2023-09-04</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">518</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">83.0%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">58.0</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">9 (1.7%)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">48.2</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1,265</td>
                </tr>
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">2023-09-05</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">524</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">84.0%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">58.3</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">12 (2.3%)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">48.8</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1,282</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal ตั้งเวลาส่งรายงาน -->
<div id="schedule-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="border-b px-6 py-4 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">ตั้งเวลาส่งรายงานอัตโนมัติ</h3>
            <button id="close-schedule-modal" class="text-gray-400 hover:text-gray-500">
                <i data-feather="x" class="h-5 w-5"></i>
            </button>
        </div>
        
        <div class="p-6">
            <form id="schedule-form">
                <div class="mb-4">
                    <label for="schedule-report-type" class="block text-sm font-medium text-gray-700 mb-1">ประเภทรายงาน</label>
                    <select id="schedule-report-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="egg_production">การผลิตไข่</option>
                        <option value="sales">ยอดขาย</option>
                        <option value="profit_loss">กำไรขาดทุน</option>
                        <option value="summary">สรุปภาพรวม</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="schedule-frequency" class="block text-sm font-medium text-gray-700 mb-1">ความถี่</label>
                    <select id="schedule-frequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="daily">ทุกวัน</option>
                        <option value="weekly">ทุกสัปดาห์</option>
                        <option value="monthly">ทุกเดือน</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="schedule-time" class="block text-sm font-medium text-gray-700 mb-1">เวลา</label>
                    <input type="time" id="schedule-time" value="09:00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div class="mb-4">
                    <label for="schedule-email" class="block text-sm font-medium text-gray-700 mb-1">อีเมลผู้รับ</label>
                    <input type="email" id="schedule-email" placeholder="email@example.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <div class="mb-4">
                    <label for="schedule-format" class="block text-sm font-medium text-gray-700 mb-1">รูปแบบไฟล์</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="format" value="pdf" checked class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">PDF</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="format" value="excel" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">Excel</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="format" value="both" class="form-radio h-4 w-4 text-primary">
                            <span class="ml-2 text-sm text-gray-700">ทั้งสองแบบ</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="submit" class="bg-primary hover:bg-accent text-white py-2 px-6 rounded-lg inline-flex items-center text-sm">
                        <i data-feather="save" class="h-4 w-4 mr-2"></i>
                        <span>บันทึก</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ตั้งค่าวันที่เริ่มต้นและสิ้นสุด
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        document.getElementById('date-from').valueAsDate = firstDayOfMonth;
        document.getElementById('date-to').valueAsDate = lastDayOfMonth;
        
        // สร้างกราฟหลัก
        const mainChartCtx = document.getElementById('mainChart').getContext('2d');
        const mainChart = new Chart(mainChartCtx, {
            type: 'line',
            data: {
                labels: ['1 ก.ย.', '2 ก.ย.', '3 ก.ย.', '4 ก.ย.', '5 ก.ย.', '6 ก.ย.', '7 ก.ย.', '8 ก.ย.', '9 ก.ย.', '10 ก.ย.', 
                         '11 ก.ย.', '12 ก.ย.', '13 ก.ย.', '14 ก.ย.', '15 ก.ย.', '16 ก.ย.', '17 ก.ย.', '18 ก.ย.', '19 ก.ย.', '20 ก.ย.',
                         '21 ก.ย.', '22 ก.ย.', '23 ก.ย.', '24 ก.ย.', '25 ก.ย.', '26 ก.ย.', '27 ก.ย.', '28 ก.ย.', '29 ก.ย.', '30 ก.ย.'],
                datasets: [{
                    label: 'จำนวนไข่ (ฟอง)',
                    data: [520, 512, 526, 518, 524, 530, 525, 515, 510, 522, 
                           528, 518, 520, 515, 510, 508, 512, 518, 522, 526, 
                           515, 520, 525, 519, 510, 508, 512, 518, 524, 528],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }, {
                    label: 'อัตราการออกไข่ (%)',
                    data: [83.2, 82.1, 84.3, 83.0, 84.0, 85.0, 84.1, 82.5, 81.8, 83.7, 
                           84.6, 83.0, 83.4, 82.6, 81.8, 81.4, 82.1, 83.0, 83.7, 84.3, 
                           82.6, 83.4, 84.2, 83.1, 81.8, 81.4, 82.1, 83.0, 84.0, 84.6],
                    borderColor: '#e74c3c',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 450,
                        title: {
                            display: true,
                            text: 'จำนวนไข่ (ฟอง)'
                        }
                    },
                    y1: {
                        beginAtZero: false,
                        min: 70,
                        max: 100,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'อัตราการออกไข่ (%)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
        
        // สร้างกราฟวงกลมแสดงประเภทไข่
        const eggTypeChartCtx = document.getElementById('eggTypeChart').getContext('2d');
        const eggTypeChart = new Chart(eggTypeChartCtx, {
            type: 'doughnut',
            data: {
                labels: ['ไข่ไซส์ S', 'ไข่ไซส์ M', 'ไข่ไซส์ L', 'ไข่ไซส์ XL', 'ไข่แตก/เสียหาย'],
                datasets: [{
                    data: [15, 45, 30, 8, 2],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                return `${label}: ${value}%`;
                            }
                        }
                    }
                }
            }
        });
        
        // อัปเดตกราฟเมื่อมีการกรองข้อมูล
        const reportFilterForm = document.getElementById('report-filter');
        if (reportFilterForm) {
            reportFilterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const reportType = document.getElementById('report-type').value;
                const timePeriod = document.getElementById('time-period').value;
                const dateFrom = document.getElementById('date-from').value;
                const dateTo = document.getElementById('date-to').value;
                
                // ในสถานการณ์จริงควรส่ง API request เพื่อดึงข้อมูลตามเงื่อนไข
                // แต่ในตัวอย่างนี้เราจะจำลองการเปลี่ยนชื่อกราฟตามประเภทรายงาน
                
                let newTitle = '';
                switch(reportType) {
                    case 'egg_production':
                        newTitle = 'ข้อมูลการผลิตไข่';
                        break;
                    case 'sales':
                        newTitle = 'ข้อมูลยอดขาย';
                        break;
                    case 'expenses':
                        newTitle = 'ข้อมูลค่าใช้จ่าย';
                        break;
                    case 'profit_loss':
                        newTitle = 'ข้อมูลกำไรขาดทุน';
                        break;
                    case 'chicken_health':
                        newTitle = 'ข้อมูลสุขภาพไก่';
                        break;
                    case 'feed_consumption':
                        newTitle = 'ข้อมูลการใช้อาหาร';
                        break;
                }
                
                // อัปเดตชื่อกราฟ
                document.querySelector('.lg\\:col-span-2 h2').textContent = newTitle;
            });
        }
        
        // Modal ตั้งเวลาส่งรายงาน
        const scheduleButton = document.getElementById('schedule-report');
        const scheduleModal = document.getElementById('schedule-modal');
        const closeScheduleModalButton = document.getElementById('close-schedule-modal');
        const scheduleForm = document.getElementById('schedule-form');
        
        // เปิด Modal
        if (scheduleButton) {
            scheduleButton.addEventListener('click', function() {
                scheduleModal.classList.remove('hidden');
            });
        }
        
        // ปิด Modal
        if (closeScheduleModalButton) {
            closeScheduleModalButton.addEventListener('click', function() {
                scheduleModal.classList.add('hidden');
            });
            
            // ปิดเมื่อคลิกข้างนอก
            scheduleModal.addEventListener('click', function(event) {
                if (event.target === scheduleModal) {
                    scheduleModal.classList.add('hidden');
                }
            });
        }
        
        // บันทึกการตั้งเวลาส่งรายงาน
        if (scheduleForm) {
            scheduleForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const reportType = document.getElementById('schedule-report-type').value;
                const frequency = document.getElementById('schedule-frequency').value;
                const time = document.getElementById('schedule-time').value;
                const email = document.getElementById('schedule-email').value;
                const format = document.querySelector('input[name="format"]:checked').value;
                
                // ในสถานการณ์จริงควรส่ง API request เพื่อบันทึกการตั้งค่า
                console.log('ตั้งเวลาส่งรายงาน:', { reportType, frequency, time, email, format });
                
                // แสดงการแจ้งเตือนว่าบันทึกสำเร็จ
                alert('บันทึกการตั้งเวลาส่งรายงานเรียบร้อยแล้ว');
                scheduleModal.classList.add('hidden');
            });
        }
        
        // ปุ่มส่งออก PDF
        const exportPdfButton = document.getElementById('export-pdf');
        if (exportPdfButton) {
            exportPdfButton.addEventListener('click', function() {
                alert('กำลังส่งออกรายงานในรูปแบบ PDF');
                // ในสถานการณ์จริงควรส่ง API request เพื่อสร้างและดาวน์โหลด PDF
            });
        }
        
        // ปุ่มส่งออก Excel
        const exportExcelButton = document.getElementById('export-excel');
        if (exportExcelButton) {
            exportExcelButton.addEventListener('click', function() {
                alert('กำลังส่งออกรายงานในรูปแบบ Excel');
                // ในสถานการณ์จริงควรส่ง API request เพื่อสร้างและดาวน์โหลด Excel
            });
        }
    });
</script>
{% endblock %} 